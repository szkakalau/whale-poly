databases:
  - name: whale-postgres
    plan: basic-1gb
    databaseName: whale
    user: whale
    ipAllowList: []

services:
  - type: keyvalue
    name: whale-redis
    plan: starter
    ipAllowList: []

  - type: web
    name: trade-ingest-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.trade_ingest.api:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: POLYMARKET_DATA_API_TRADES_URL
        value: https://data-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_TRADES_URL_FALLBACK
        value: https://backup-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_ALERT_CHAT_ID
        sync: false
      - key: WECHAT_WEBHOOK_URL
        sync: false

  - type: worker
    name: trade-ingest-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.trade_ingest.worker:celery_app worker -B -l INFO -Q trade_ingest
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: POLYMARKET_DATA_API_TRADES_URL
        value: https://data-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_TRADES_URL_FALLBACK
        value: https://backup-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false
      - key: TELEGRAM_HEALTH_BOT_TOKEN
        sync: false
      - key: TELEGRAM_HEALTH_CHAT_ID
        sync: false
      - key: TELEGRAM_HEALTH_USERNAME
        sync: false

  - type: web
    name: whale-engine-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.whale_engine.api:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: WHALE_SINGLE_TRADE_USD_THRESHOLD
        value: "5000"
      - key: WHALE_BUILD_USD_THRESHOLD
        value: "5000"

  - type: worker
    name: whale-engine-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.whale_engine.worker:celery_app worker -B -l INFO -Q whale_engine
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: WHALE_SINGLE_TRADE_USD_THRESHOLD
        value: "5000"
      - key: WHALE_BUILD_USD_THRESHOLD
        value: "5000"

  - type: web
    name: alert-engine-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.alert_engine.api:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_MIN_TRADE_USD
        value: "5000"
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false

  - type: worker
    name: alert-engine-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.alert_engine.worker:celery_app worker -B -l INFO -Q alert_engine
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_MIN_TRADE_USD
        value: "5000"
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false

  - type: worker
    name: telegram-bot
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: uvicorn services.telegram_bot.api:app --host 0.0.0.0 --port 10000
    envVars:
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_FANOUT_RATE_LIMIT_PER_MINUTE
        value: "50"
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: BOT_USER_HASH_SECRET
        sync: false
      - key: TELEGRAM_ALERT_CHAT_ID
        sync: false

  - type: web
    name: payment-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.payment.api:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
