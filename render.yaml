databases:
  - name: whale-postgres
    plan: basic-1gb
    databaseName: whale
    user: whale
    ipAllowList: []

services:
  - type: keyvalue
    name: whale-redis
    plan: starter
    ipAllowList: []

  - type: web
    name: trade-ingest-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.trade_ingest.api:app --host 0.0.0.0 --port $PORT --workers 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: POLYMARKET_DATA_API_TRADES_URL
        value: https://data-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_TRADES_URL_FALLBACK
        value: https://backup-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_ALERT_CHAT_ID
        sync: false
      - key: WECHAT_WEBHOOK_URL
        sync: false

  - type: worker
    name: trade-ingest-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.trade_ingest.worker:celery_app worker -B -l INFO -Q trade_ingest --concurrency=1 --prefetch-multiplier=1 --max-tasks-per-child=200
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: POLYMARKET_DATA_API_TRADES_URL
        value: https://data-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_TRADES_URL_FALLBACK
        value: https://backup-api.polymarket.com/trades
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false
      - key: TELEGRAM_HEALTH_BOT_TOKEN
        sync: false
      - key: TELEGRAM_HEALTH_CHAT_ID
        sync: false
      - key: TELEGRAM_HEALTH_USERNAME
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_ALERT_CHAT_ID
        sync: false
      - key: HEALTH_PAYMENT_API_URL
        value: https://payment-api-6wk6.onrender.com
      - key: HEALTH_TELEGRAM_BOT_API_URL
        value: https://telegram-bot-qk51.onrender.com
      - key: MARKET_INGEST_SECONDS
        value: "600"
      - key: TRADE_INGEST_SECONDS
        value: "30"
      - key: MARKET_INGEST_MAX
        value: "300"
      - key: MARKET_INGEST_BATCH
        value: "25"

  - type: web
    name: whale-engine-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.whale_engine.api:app --host 0.0.0.0 --port $PORT --workers 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: WHALE_SINGLE_TRADE_USD_THRESHOLD
        value: "5000"
      - key: WHALE_BUILD_USD_THRESHOLD
        value: "5000"

  - type: worker
    name: whale-engine-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.whale_engine.worker:celery_app worker -B -l INFO -Q whale_engine --concurrency=1 --prefetch-multiplier=1 --max-tasks-per-child=200
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: TRADE_CREATED_QUEUE
        value: trade_created
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: WHALE_SINGLE_TRADE_USD_THRESHOLD
        value: "5000"
      - key: WHALE_BUILD_USD_THRESHOLD
        value: "5000"
      - key: WHALE_STATS_TRADE_CAP
        value: "15"
      - key: WHALE_STATS_DAYS_7
        value: "3"
      - key: WHALE_STATS_DAYS_30
        value: "10"
      - key: WHALE_STATS_DAYS_90
        value: "30"
      - key: WHALE_RECOMPUTE_SECONDS
        value: "1800"
      - key: WHALE_CONSUME_SECONDS
        value: "1"
      - key: TRADE_CONSUME_BATCH
        value: "10"
      - key: WHALE_STATS_RAW_TRADE_CAP
        value: "5000"
      - key: WHALE_STATS_HISTORY_CAP
        value: "10000"

  - type: web
    name: alert-engine-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.alert_engine.api:app --host 0.0.0.0 --port $PORT --workers 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_MIN_TRADE_USD
        value: "5000"
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false

  - type: worker
    name: alert-engine-worker
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    dockerCommand: celery -A services.alert_engine.worker:celery_app worker -B -l INFO -Q alert_engine --concurrency=1 --prefetch-multiplier=1 --max-tasks-per-child=200
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: WHALE_TRADE_CREATED_QUEUE
        value: whale_trade_created
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_MIN_TRADE_USD
        value: "5000"
      - key: POLYMARKET_DATA_API_MARKETS_URL
        value: https://gamma-api.polymarket.com/markets
      - key: HTTPS_PROXY
        sync: false

  - type: web
    name: telegram-bot
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /health
    dockerCommand: uvicorn services.telegram_bot.api:app --host 0.0.0.0 --port $PORT --workers 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: ALERT_CREATED_QUEUE
        value: alert_created
      - key: ALERT_FANOUT_RATE_LIMIT_PER_MINUTE
        value: "50"
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: BOT_USER_HASH_SECRET
        sync: false
      - key: TELEGRAM_ALERT_CHAT_ID
        sync: false

  - type: web
    name: payment-api
    runtime: docker
    rootDir: whale-monorepo
    dockerfilePath: docker/Dockerfile
    healthCheckPath: /healthz
    dockerCommand: uvicorn services.payment.api:app --host 0.0.0.0 --port $PORT --workers 1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: whale-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: whale-redis
          type: keyvalue
          property: connectionString
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: LANDING_SUCCESS_URL
        sync: false
      - key: LANDING_CANCEL_URL
        sync: false
      - key: PAYMENT_MODE
        value: stripe
      - key: DEFAULT_CURRENCY
        value: usd
